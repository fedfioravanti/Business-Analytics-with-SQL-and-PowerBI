/* question 01.01 */

SELECT i.billingcountry, COUNT(i.invoiceid) as invoices
FROM invoice i
GROUP BY i.billingcountry
ORDER BY invoices DESC



---

/* question 01.02 */

SELECT i.billingcity, SUM(i.total) as invoice_totals
FROM invoice i
GROUP BY i.billingcity
ORDER BY invoice_totals DESC
LIMIT 1



---

/* question 01.03 */

SELECT c.customerid, SUM(i.total) as customer_total
FROM customer c
JOIN invoice i
ON c.customerid = i.customerid
GROUP BY c.customerid
ORDER BY customer_total DESC



---

/* question 02.01 */

SELECT c.email, c.firstname, c.lastname, g.name
FROM customer c
JOIN invoice i
ON c.customerid = i.customerid
JOIN invoiceline l
ON i.invoiceid = l.invoiceid
JOIN track t
ON l.trackid = t.trackid
JOIN genre g
ON t.genreid = g.genreid
WHERE g.name='Rock'
GROUP BY c.email, c.firstname, c.lastname, g.name
ORDER BY c.email



---

/* question 02.02 */

SELECT a.artistid, a.name, COUNT(t.trackid) as Songs
FROM artist a
JOIN album b
ON a.artistid = b.artistid
JOIN track t
ON b.albumid = t.albumid
JOIN genre g
ON t.genreid = g.genreid
WHERE g.name='Rock'
GROUP BY a.artistid, a.name
ORDER BY Songs DESC
LIMIT 10



---

/* question 02.03 */

SELECT a.name, SUM(l.unitprice * l.quantity) as AmountSpent
FROM artist a
JOIN album b
ON a.artistid = b.artistid
JOIN track t
ON b.albumid = t.albumid
JOIN invoiceline l
ON t.trackid = l.trackid
JOIN invoice i
ON l.invoiceid = i.invoiceid
JOIN customer c
ON i.customerid = c.customerid
GROUP BY a.name
ORDER BY AmountSpent DESC
LIMIT 10



---

/* question 02.03a */

SELECT a.name, SUM(l.unitprice * l.quantity) as AmountSpent, c.customerid, c.firstname, c.lastname
FROM artist a
JOIN album b
ON a.artistid = b.artistid
JOIN track t
ON b.albumid = t.albumid
JOIN invoiceline l
ON t.trackid = l.trackid
JOIN invoice i
ON l.invoiceid = i.invoiceid
JOIN customer c
ON i.customerid = c.customerid
GROUP BY a.name, c.customerid, c.firstname, c.lastname
ORDER BY AmountSpent DESC
LIMIT 10



---

/* question 03.01 */

WITH GenrePerCountry AS
    (SELECT SUM(l.quantity) as Purchases, c.country, g.name, g.genreid
     FROM customer c
     JOIN invoice i
     ON c.customerid = i.customerid
     JOIN invoiceline l
     ON i.invoiceid = l.invoiceid
     JOIN track t
     ON l.trackid = t.trackid
     JOIN genre g
     ON t.genreid = g.genreid
     GROUP BY l.quantity, c.country, g.name, g.genreid
     ORDER BY c.country)

SELECT a.Purchases, a.country, a.name, a.genreid
FROM GenrePerCountry a
WHERE a.Purchases = (SELECT MAX(Purchases)
                      FROM GenrePerCountry
		      WHERE a.country = Country
		      GROUP BY Country)
ORDER BY Country



---

/* question 03.02 */

SELECT name, milliseconds
FROM track
GROUP BY name, milliseconds
HAVING milliseconds > (SELECT AVG(milliseconds)
                       FROM track)
ORDER BY milliseconds DESC



---

/* question 03.03 */

WITH CustomerPerCountry AS
    (SELECT c.country, SUM(i.total) as TotalSpent, c.firstname, c.lastname, c.customerid
     FROM customer c
     JOIN invoice i
     ON c.customerid = i.customerid
     GROUP BY c.country, c.firstname, c.lastname, c.customerid
     ORDER BY TotalSpent DESC)

SELECT a.country, a.TotalSpent, a.firstname, a.lastname, a.customerid
FROM CustomerPerCountry a
WHERE a.TotalSpent = (SELECT MAX(TotalSpent)
                      FROM CustomerPerCountry
		      WHERE a.country = Country
		      GROUP BY Country)
ORDER BY Country

---


---


1. What genre has the longest song on average?
2. What is the most popular genre for each city?
3. What month had the highest sales in the USA?
4. What media type had the most sales?


---

/* query 01 */

SELECT g.name AS "Genre", ROUND(AVG(t.milliseconds)/1000, 2) AS "Average Length of Songs (sec)"
FROM track t
JOIN genre g
ON t.genreid = g.genreid
GROUP BY 1
ORDER BY 2 DESC



---

/* query 02 */

WITH GenrePerCity AS
    (SELECT SUM(l.quantity) AS Purchases, c.city, c.country, g.name
     FROM customer c
     JOIN invoice i
     ON c.customerid = i.customerid
     JOIN invoiceline l
     ON i.invoiceid = l.invoiceid
     JOIN track t
     ON l.trackid = t.trackid
     JOIN genre g
     ON t.genreid = g.genreid
     GROUP BY 2, 3, 4
     ORDER BY 2)

SELECT a.city AS "City", a.country AS "Country", a.name AS "Genre", a.Purchases AS "Total Number of Purchases"
FROM GenrePerCity a
WHERE a.Purchases = (SELECT MAX(Purchases)
                     FROM GenrePerCity
		     WHERE a.city = City
		     GROUP BY City)
ORDER BY Purchases DESC




---

/* query 03 */

SELECT DATE_TRUNC('month', i.invoicedate) AS "Month", SUM(i.total) AS "Total Amount of Purchases (USD)"
FROM invoice i
JOIN customer c
ON i.customerid = c.customerid
WHERE c.country = 'USA'
GROUP BY 1
ORDER BY 2 DESC



---

/* query 04 */

SELECT m.name AS "Media Type", SUM(l.unitprice*l.quantity) AS "Total Amount of Purchases (USD)" 
FROM mediatype m
JOIN track t
ON m.mediatypeid = t.mediatypeid
JOIN invoiceline l
ON t.trackid = l.trackid
JOIN invoice i
ON l.invoiceid = i.invoiceid
GROUP BY 1
ORDER BY 2 DESC



---

/* query 03 */ ---OLD--- /  What is the most prolific artist for each genre?  /

WITH ArtistPerGenre AS
    (SELECT g.name AS genre_name, a.name, COUNT(t.trackid) AS Songs
     FROM artist a
     JOIN album b
     ON a.artistid = b.artistid
     JOIN track t
     ON b.albumid = t.albumid
     JOIN genre g
     ON t.genreid = g.genreid
     GROUP BY 1, 2
     ORDER BY 1)

SELECT s.genre_name AS "Genre", s.name AS "Artist", s.Songs AS "Total Number of Songs"
FROM ArtistPerGenre s
WHERE s.Songs = (SELECT MAX(Songs)
                 FROM ArtistPerGenre
		 WHERE s.genre_name = Genre
		 GROUP BY Genre)
ORDER BY Genre





